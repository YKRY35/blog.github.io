<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>脱壳实践之会玩APP你画我猜外挂 &mdash; Zhou</title><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/collection.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/globals/common.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/posts/index.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/octicons/octicons/octicons.css"><link href="https://ykry35.github.io/blog.github.io/assets/vendor/viewerjs/viewer.min.css" rel="stylesheet"><link href="https://ykry35.github.io/blog.github.io/assets/css/globals/viewerjs.cust.css" rel="stylesheet"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/code_theme/github.css"><link rel="canonical" href="https://ykry35.github.io/blog.github.io/2023/01/08/hack_huiwan_drawguess_01/"><link rel="alternate" type="application/atom+xml" title="Zhou" href="https://ykry35.github.io/blog.github.io/feed.xml"><link rel="shortcut icon" href="https://ykry35.github.io/blog.github.io/favicon.ico"><meta property="og:title" content="脱壳实践之会玩APP你画我猜外挂"><meta name="keywords" content="逆向, 安卓"><meta name="og:keywords" content="逆向, 安卓"><meta name="description" content=""><meta name="og:description" content=""><meta property="og:url" content="https://ykry35.github.io/blog.github.io/2023/01/08/hack_huiwan_drawguess_01/"><meta property="og:site_name" content="Zhou"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2023-01-08"> <script src="https://ykry35.github.io/blog.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/js/jquery-ui.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/js/main.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/vendor/viewerjs/viewer.min.js"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?21948165144e39ea102cb9ab226cef96"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://ykry35.github.io/blog.github.io/" title="Zhou"><span class="octicon octicon-mark-github"></span> Zhou</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://ykry35.github.io/blog.github.io/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://ykry35.github.io/blog.github.io/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://ykry35.github.io/blog.github.io/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://ykry35.github.io/blog.github.io/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://ykry35.github.io/blog.github.io/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="脱壳实践之会玩APP你画我猜外"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">脱壳实践之会玩APP你画我猜外挂</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2023/01/08 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://ykry35.github.io/blog.github.io/categories/#Android" title="Android">Android</a> </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="效果">效果</h1><div id="jekyllconfig"> { "viewerjs": { "img_width": "260px" } }</div><p>你画我猜改词。。</p><blockquote><p>效果1 整蛊所有路人</p></blockquote><p>图1是第一次选这个词CXQ。</p><p>后来连续好几盘都是这个词，便出现了图2。</p><p>后来我突然换了词，就是图三。</p><ul class="images_group"><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//xiaoguo_01.jpeg" alt="Picture 1" /></li><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//xiaoguo_02.jpeg" alt="Picture 1" /></li><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//xiaoguo_03.jpeg" alt="Picture 1" /></li></ul><h1 id="前置知识">前置知识</h1><p>其实从脱壳到分析到做辅助功能，最大工作量在于脱壳那一步。</p><p>头一回做，脱壳的成本占了8成。但是后面，脱壳的方案已经稳定，基本就不再占多少成本了。</p><h2 id="脱壳">脱壳</h2><p>上一篇提到，应用APK源码都被加壳保护了，要拿源码需要脱壳。</p><p>详见 <a href="https://ykry35.github.io/blog.github.io/2023/01/04/zhou_s_dex_unpacker/">周氏APP脱壳法</a></p><h2 id="art类加载机制">ART类加载机制</h2><p>也在这里边讲到。 <a href="https://ykry35.github.io/blog.github.io/2023/01/04/zhou_s_dex_unpacker/">周氏APP脱壳法</a></p><h2 id="hook">Hook</h2><p>我们虽然拿到了源码，但是是不能编译的，缺少了很多东西（资源啊，项目结构啊）。</p><p>那如何修改程序逻辑呢? Hook大法。</p><p>Hook就是打钩子，监听一个函数调用的生命周期，拥有修改函数入参、返回值的能力。</p><p>比如噢，有个程序是这样的：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">coinsNum</span><span class="o">(){</span>
    <span class="k">return</span> <span class="mi">100</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>我们想要hook这个函数返回，获取金币功能返回100000. 那么这个函数被hook完最终效果就张这样：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">coinsNum</span><span class="o">(){</span>
    <span class="k">return</span> <span class="mi">100000</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>这是hook，在不需要编译打包源程序的情况，修改某个函数的逻辑。</p><h2 id="xposed">Xposed</h2><p>那么，谁来提供这个Hook能力呢？ 安卓经典框架Xposed。</p><p>但是Xposed原理上修改了app_process，通过不了谷歌SafetyNet检测，因此装了Xposed的设备会玩APP会闪退。</p><p>Xposed本身也已经被抛弃，现在高版本安卓用的比较多的是LSPosed和EdXposed（都基于Magisk）</p><p>但是经实验，EdXposed仍然会被检测，而LSposed不会。</p><p>因此Hook程序最终选择的方案是LSPosed。</p><p>庆幸的是，LSPosed继承了Xposed的API，因此开发上和以前没有差异。</p><h1 id="制作">制作</h1><h2 id="获得源码">获得源码.</h2><p>将前面脱壳的Dex全部反编译，得到N个jar包，用来分析源程序逻辑。</p><p>下面开始照着功能分析，寻找漏洞（联机APP，走服务器的只能期盼逻辑疏漏，如果服务器够强大，是不可能有机可乘的）。</p><h2 id="分析源码">分析源码</h2><ul><li><strong>打开APP，用adb命令看一下当前顶层的Activity名字</strong></li></ul><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zhou@zhou-LAPKC71E:~<span class="nv">$ </span>adb shell dumpsys window windows | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'mCurrentFocus|mFocusedApp'</span>
  <span class="nv">mCurrentFocus</span><span class="o">=</span>Window<span class="o">{</span>af81c3d u0 com.wepie.weplay/com.wepie.wespy.module.fixroom.FixRoomActivity<span class="o">}</span>
  <span class="nv">mFocusedApp</span><span class="o">=</span>AppWindowToken<span class="o">{</span>22e4185 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>1a58bef ActivityRecord<span class="o">{</span>bf340ce u0 com.wepie.weplay/com.wepie.wespy.module.fixroom.FixRoomActivity t164<span class="o">}}}</span>

</code></pre></div></div><p>得知当前Activity是com.wepie.wespy.module.fixroom.FixRoomActivity</p><p>简单阅读源码可以知道，很多游戏的Activity都是这个FixRoomActivity，而内容是由不同的View决定的，看这一段：</p><ul class="images_group"><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//sc_01.png" alt="Picture 1" /></li></ul><p>所以，我们的关注就点来到了 DrawGuessGameView 。翻阅一下。。</p><p>关注这个类的这个方法，这不就是轮到我画时的选词吗。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">showChooseWord</span><span class="o">(</span><span class="nc">DrawGuessGameInfo</span> <span class="n">paramDrawGuessGameInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">drawMainView</span><span class="o">.</span><span class="na">clearTotal</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">drawMainView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">iconBgIv</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">drawMainView</span><span class="o">.</span><span class="na">showGuess</span><span class="o">(</span><span class="n">paramDrawGuessGameInfo</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">hideDrawGuideAnim</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">paramDrawGuessGameInfo</span><span class="o">.</span><span class="na">myDrawTime</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">DrawWordDialog</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">getContext</span><span class="o">(),</span> <span class="n">paramDrawGuessGameInfo</span><span class="o">.</span><span class="na">getWordInfoList</span><span class="o">(),</span> <span class="n">paramDrawGuessGameInfo</span><span class="o">.</span><span class="na">myChangeCost</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">chooseWordLay</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">chooseWordTv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">CHINA</span><span class="o">,</span> <span class="s">"%d号正在选词..."</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">paramDrawGuessGameInfo</span><span class="o">.</span><span class="na">getDrawerSeatNum</span><span class="o">())</span> <span class="o">}));</span>
      <span class="nc">UserService</span><span class="o">.</span><span class="na">_CC</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getCacheSimpleUser</span><span class="o">(</span><span class="n">paramDrawGuessGameInfo</span><span class="o">.</span><span class="na">getDrawUid</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">UserSimpleInfoCallback</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUserInfoFailed</span><span class="o">(</span><span class="nc">String</span> <span class="n">param1String</span><span class="o">)</span> <span class="o">{}</span>
            
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUserInfoSuccess</span><span class="o">(</span><span class="nc">UserSimpleInfo</span> <span class="n">param1UserSimpleInfo</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">ImageLoaderUtil</span><span class="o">.</span><span class="na">loadCircleHeadImage</span><span class="o">(</span><span class="n">param1UserSimpleInfo</span><span class="o">.</span><span class="na">headimgurl</span><span class="o">,</span> <span class="o">(</span><span class="nc">ImageView</span><span class="o">)</span><span class="nc">DrawGuessGameView</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">chooseWordIv</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">});</span>
    <span class="o">}</span> 
  <span class="o">}</span>
</code></pre></div></div><p>那么DrawWordDialog.show就是选词的框框。跟进去。</p><p>DrawWordDialog节选。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DrawWordDialog</span> <span class="kd">extends</span> <span class="nc">BaseDialogFragment</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">selectWord</span><span class="o">(</span><span class="nc">DrawGuessGameInfo</span><span class="o">.</span><span class="na">WordInfo</span> <span class="n">paramWordInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DrawGuessSenderPresenter</span><span class="o">.</span><span class="na">selectWord</span><span class="o">(</span><span class="n">paramWordInfo</span><span class="o">.</span><span class="na">getWord</span><span class="o">(),</span> <span class="n">paramWordInfo</span><span class="o">.</span><span class="na">getPrompt</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">DrawGuessSenderPresenter</span><span class="o">.</span><span class="na">DrawSeqCallback</span><span class="o">()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="nc">RspHeadInfo</span> <span class="n">param1RspHeadInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">DrawWordDialog</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">});</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">(</span><span class="nc">Context</span> <span class="n">paramContext</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DrawGuessGameInfo</span><span class="o">.</span><span class="na">WordInfo</span><span class="o">&gt;</span> <span class="n">paramList</span><span class="o">,</span> <span class="kt">int</span> <span class="n">paramInt</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DrawWordDialog</span> <span class="n">drawWordDialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DrawWordDialog</span><span class="o">();</span>
    <span class="nc">Bundle</span> <span class="n">bundle</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bundle</span><span class="o">();</span>
    <span class="n">bundle</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"cost"</span><span class="o">,</span> <span class="n">paramInt</span><span class="o">);</span>
    <span class="n">bundle</span><span class="o">.</span><span class="na">putParcelableArrayList</span><span class="o">(</span><span class="s">"word_info"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">DrawGuessGameInfo</span><span class="o">.</span><span class="na">WordInfo</span><span class="o">&gt;(</span><span class="n">paramList</span><span class="o">));</span>
    <span class="n">drawWordDialog</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">paramContext</span><span class="o">,</span> <span class="n">bundle</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="nc">LayoutInflater</span> <span class="n">paramLayoutInflater</span><span class="o">,</span> <span class="nc">ViewGroup</span> <span class="n">paramViewGroup</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">paramBundle</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">updateCancelable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">paramLayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="mi">2131493512</span><span class="o">,</span> <span class="n">paramViewGroup</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="nc">RecyclerView</span> <span class="n">recyclerView</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RecyclerView</span><span class="o">)</span><span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="mi">2131304256</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lm</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">LayoutManager</span><span class="o">)</span><span class="k">new</span> <span class="nc">GridLayoutManager</span><span class="o">(</span><span class="n">paramLayoutInflater</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="mi">2</span><span class="o">);</span>
    <span class="n">recyclerView</span><span class="o">.</span><span class="na">setLayoutManager</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">lm</span><span class="o">);</span>
    <span class="n">recyclerView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">((</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">Adapter</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">adapter</span><span class="o">);</span>
    <span class="n">recyclerView</span><span class="o">.</span><span class="na">addItemDecoration</span><span class="o">((</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ItemDecoration</span><span class="o">)</span><span class="k">new</span> <span class="nc">SpaceItemDecoration</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">ScreenUtil</span><span class="o">.</span><span class="na">dip2px</span><span class="o">(</span><span class="mf">4.0</span><span class="no">F</span><span class="o">),</span> <span class="nc">ScreenUtil</span><span class="o">.</span><span class="na">dip2px</span><span class="o">(</span><span class="mf">12.0</span><span class="no">F</span><span class="o">),</span> <span class="nc">ScreenUtil</span><span class="o">.</span><span class="na">dip2px</span><span class="o">(</span><span class="mf">4.0</span><span class="no">F</span><span class="o">)));</span>
    <span class="k">this</span><span class="o">.</span><span class="na">adapter</span><span class="o">.</span><span class="na">setOnItemClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">OnItemClickListener</span><span class="o">&lt;</span><span class="nc">DrawGuessGameInfo</span><span class="o">.</span><span class="na">WordInfo</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClickItem</span><span class="o">(</span><span class="nc">DrawGuessGameInfo</span><span class="o">.</span><span class="na">WordInfo</span> <span class="n">param1WordInfo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">param1Int</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">DrawWordDialog</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">selectWord</span><span class="o">(</span><span class="n">param1WordInfo</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">});</span>
    <span class="k">this</span><span class="o">.</span><span class="na">changeTv</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span><span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="mi">2131304249</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">changeTv</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">param1View</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">DrawWordDialog</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">changeWord</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">});</span>
    <span class="n">initData</span><span class="o">();</span>
    <span class="n">updateWords</span><span class="o">();</span>
    <span class="n">updateChangeLay</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>从onCreateView可以分析出，这里可以选词selectWord或者换词changeWord.</p><p>我们跟进selectWord. DrawGuessSenderPresenter.java节选。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DrawGuessSenderPresenter</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">selectWord</span><span class="o">(</span><span class="nc">String</span> <span class="n">paramString1</span><span class="o">,</span> <span class="nc">String</span> <span class="n">paramString2</span><span class="o">,</span> <span class="nc">DrawSeqCallback</span> <span class="n">paramDrawSeqCallback</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DrawGuessPacketSender</span><span class="o">.</span><span class="na">selectWord</span><span class="o">(</span><span class="n">paramString1</span><span class="o">,</span> <span class="n">paramString2</span><span class="o">,</span> <span class="n">paramDrawSeqCallback</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>这里就是发送数据包了。将选词的结果发送给服务器。让所有玩家都开始进入这一轮游戏。</p><p>我们观察selectWord有三个参数，但三个参数名都被编译时混淆了，无法获知含义。第三个参数通过类名和前面调用处的处理可知，是个回调。关键是前两个参数的含义。</p><p>所以此时，我们就要hook这个selectWord方法，将参数值全部打印出来。来分析其含义。</p><p>写一个Xposed程序，实现上述功能。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loadClass</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="s">"com.wepie.wespy.module.draw.pkt.DrawGuessSenderPresenter"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LoadClassCb</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoad</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Find DrawGuessSenderPresenter"</span><span class="o">);</span>
                <span class="nc">XposedBridge</span><span class="o">.</span><span class="na">hookAllMethods</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"selectWord"</span><span class="o">,</span> <span class="k">new</span> <span class="n">XC_MethodHook</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">beforeHookedMethod</span><span class="o">(</span><span class="nc">MethodHookParam</span> <span class="n">param</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
                        <span class="kd">super</span><span class="o">.</span><span class="na">beforeHookedMethod</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
                        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"selectWord... "</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">});</span>
</code></pre></div></div><p>会将参数打印到android日志。</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zhou@zhou-LAPKC71E:~<span class="nv">$ </span>adb logcat|grep Zhou_Wepie
01-08 01:17:35.829  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:35.829  8186  8186 D Zhou_Wepie: Find DrawGuessSenderPresenter
01-08 01:17:41.808  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:45.026  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:47.100  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:49.887  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:51.956  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:17:53.835  8186  8186 D Zhou_Wepie: FIND FixRoomActivity
01-08 01:18:16.299  8186  8186 D Zhou_Wepie: selectWord... 名侦探柯南 日本动漫
01-08 01:18:19.926  8186  8186 D Zhou_Wepie: com.android.chrome
</code></pre></div></div><p>第一个参数”名侦探柯南”， 第二个是”日本动漫”。那么可以知道第一个参数是选的词，第二个是提示。</p><p>再往selectWord函数里面跟几层，发现并没有什么更多的处理了。所以我们发现了一个疑似漏洞的点。</p><p><strong>或许服务器最终接受的词语是客户端直接发过去的，服务器可能没有做校验。</strong></p><p>我们实验一下。改掉这两个参数的值。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">loadClass</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="s">"com.wepie.wespy.module.draw.pkt.DrawGuessSenderPresenter"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LoadClassCb</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoad</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Find DrawGuessSenderPresenter"</span><span class="o">);</span>
                <span class="nc">XposedBridge</span><span class="o">.</span><span class="na">hookAllMethods</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"selectWord"</span><span class="o">,</span> <span class="k">new</span> <span class="n">XC_MethodHook</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">beforeHookedMethod</span><span class="o">(</span><span class="nc">MethodHookParam</span> <span class="n">param</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
                        <span class="kd">super</span><span class="o">.</span><span class="na">beforeHookedMethod</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
                        <span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"selectWord... "</span><span class="o">);</span>
                        <span class="n">param</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">"蔡徐坤"</span><span class="o">;</span>
                        <span class="n">param</span><span class="o">.</span><span class="na">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="s">"网络带红人"</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">});</span>
</code></pre></div></div><p>安装这个Xposed模块，重启应用。然后正常选词，看看效果。</p><ul class="images_group"><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//jieguo_01.jpeg" alt="Picture 1" /></li><li><img src="https://ykry35.github.io/blog.github.io/assets/images/posts/hack_huiwan_drawguess_01//jieguo_02.jpeg" alt="Picture 1" /></li></ul><p>可以看到提供给我们的词和我最后选的词一点不一样。。 说明<strong>服务器真的存在这个逻辑漏洞</strong>!!!</p><p><strong>至此，我们完成了这个外挂的制作。利用了服务器没校验词语的漏洞。</strong></p><p><strong>稍作修改，就可以整蛊啦！</strong></p><h2 id="还有一件事">还有一件事</h2><p><img src="https://ykry35.github.io/blog.github.io/assets/images/common//haiyouyijianshi.png" alt="" /></p><p>这个功能可以做一个Service输入框挂在最顶层，然后进程间通信拿到想要的词语。最终做到自定义词语。</p><p>别的功能，比如控制画笔，在别人画的时候自己也能画等等，就只能有空去分析发掘了。</p><p>另外，其实这个分析思路是纯事后的正向推理。真正分析时，是到处翻，找到关键点时再正向或逆向。在找到这个点前也有一些失败的点（无逻辑漏洞）。</p><h1 id="别的">别的</h1><p>其实，最开始的切入点，是想在狼人杀那里的，可是那个被改造成Unity了，执行逻辑跑到native层了。超出笔者的水平了。</p><p>不能在狼人杀里整蛊了，呜呜呜。。</p><p>以前老版本的，狼人杀用的语音频道是第三方的工具，通过控制，可以在当好人时，加入狼人频道整蛊。可惜了。。。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://ykry35.github.io/blog.github.io" target="_blank">Chaoxin Zhou</a></li><li>本文链接：<a href="https://ykry35.github.io/blog.github.io/2023/01/08/hack_huiwan_drawguess_01/" target="_blank">https://ykry35.github.io/blog.github.io/2023/01/08/hack_huiwan_drawguess_01/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2023/01/08/hack_huiwan_drawguess_01/', clientID: 'a3a0fbaad3e91f2e2342', clientSecret: 'f82d523505992a3aab199b818ecff081b65f1a60', repo: 'blog.github.io', owner: 'ykry35', admin: ['ykry35'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://ykry35.github.io/blog.github.io/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://ykry35.github.io/blog.github.io/assets/search_data.json?v=1673325926', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://ykry35.github.io/blog.github.io/assets/js/jquery.toc.js"></script></div></div><script type="text/javascript"> $(document).ready(function(){ const jekyllConfigId = '#jekyllconfig'; const imageGroupClass = '.images_group'; $(jekyllConfigId).hide(); var configStr = $(jekyllConfigId).text().trim(); const jekyllConfig = JSON.parse(configStr); console.log("jekyllConfig", jekyllConfig); $(imageGroupClass + ' li').css('width', jekyllConfig['viewerjs']['img_width']); $(imageGroupClass).each(function(index, element) { new Viewer(element); }); }); </script></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Chaoxin Zhou">Chaoxin Zhou</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/YKRY35/" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://ykry35.github.io/blog.github.io/" title="首页" target="">首页</a></li><li> <a href="https://ykry35.github.io/blog.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://ykry35.github.io/blog.github.io/wiki/" title="维基" target="">维基</a></li><li> <a href="https://ykry35.github.io/blog.github.io/links/" title="链接" target="">链接</a></li><li> <a href="https://ykry35.github.io/blog.github.io/about/" title="关于" target="">关于</a></li><li><a href="https://ykry35.github.io/blog.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://ykry35.github.io/blog.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
