<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>jacoco启动改造成attach &mdash; Zhou</title><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/collection.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/globals/common.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/posts/index.css"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/octicons/octicons/octicons.css"><link href="https://ykry35.github.io/blog.github.io/assets/vendor/viewerjs/viewer.min.css" rel="stylesheet"><link href="https://ykry35.github.io/blog.github.io/assets/css/globals/viewerjs.cust.css" rel="stylesheet"><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/css/code_theme/github.css"><link rel="canonical" href="https://ykry35.github.io/blog.github.io/hidden/jacoco_attach/"><link rel="alternate" type="application/atom+xml" title="Zhou" href="https://ykry35.github.io/blog.github.io/feed.xml"><link rel="shortcut icon" href="https://ykry35.github.io/blog.github.io/favicon.ico"><meta property="og:title" content="jacoco启动改造成attach"><meta name="keywords" content="jvm, Java, jacoco"><meta name="og:keywords" content="jvm, Java, jacoco"><meta name="description" content="a"><meta name="og:description" content="a"><meta property="og:url" content="https://ykry35.github.io/blog.github.io/hidden/jacoco_attach/"><meta property="og:site_name" content="Zhou"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /> <script src="https://ykry35.github.io/blog.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/js/jquery-ui.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/js/main.js"></script> <script src="https://ykry35.github.io/blog.github.io/assets/vendor/viewerjs/viewer.min.js"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?21948165144e39ea102cb9ab226cef96"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://ykry35.github.io/blog.github.io/" title="Zhou"><span class="octicon octicon-mark-github"></span> Zhou</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://ykry35.github.io/blog.github.io/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://ykry35.github.io/blog.github.io/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://ykry35.github.io/blog.github.io/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://ykry35.github.io/blog.github.io/links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://ykry35.github.io/blog.github.io/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="jacoco启动改造成atta"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">jacoco启动改造成attach</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://ykry35.github.io/blog.github.io/categories/#jacoco" title="jacoco">jacoco</a> </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>关注以下几个点。</p><h1 id="栈帧中的方法被改了会发生什么">栈帧中的方法被改了会发生什么？</h1><p><a href="https://ykry35.github.io/blog.github.io/2021/08/31/retransform_class_mechanism/">重定义字节码机制</a></p><h1 id="哪些类不能被重定义">哪些类不能被重定义？</h1><p>isModifiableClass 的官方注释：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Primitive classes (for example, &lt;code&gt;java.lang.Integer.TYPE&lt;/code&gt;)
* and array classes are never modifiable.

*/
boolean
isModifiableClass(Class&lt;?&gt; theClass);
</code></pre></div></div><h1 id="jvm限制">JVM限制</h1><p>热更新字节码，不能往类中加/删字段，不能加/删方法，不能修改方法的参数和返回类型。</p><h2 id="jacocoaccess">$jacocoAccess</h2><p>用来获取探针。jacoco的agent启动时，塞在一个跟加载器的类中。</p><p>例如：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">java.lang</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnknownError</span><span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">RuntimeData</span> <span class="n">$jacocoAccess</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>通过调用 boolean[] UnknownError.$jacocoAccess.equals()方法，来向RuntimeData索要覆盖率探针。</p><p>那么这个点的改造方案是，由于不能插入字段了，那就直接把RuntimeData挂在跟加载器上。</p><p>挂根加载器(null)的方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Instrumentation</span> <span class="n">instr</span><span class="o">;</span>
<span class="n">instr</span><span class="o">.</span><span class="na">appendToBootstrapClassLoaderSearch</span><span class="o">(</span><span class="k">new</span> <span class="nc">JarFile</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
</code></pre></div></div><p>把一个jar包丢到根加载器的扫描路径里。</p><h2 id="已经加载过的所有类补插入探针">已经加载过的所有类补插入探针</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Instrumentation</span> <span class="n">instr</span><span class="o">;</span>
<span class="nc">Class</span><span class="o">[]</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="na">getAllLoadedClasses</span><span class="o">();</span>
</code></pre></div></div><p>拿到所有加载过的类。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inst</span><span class="o">.</span><span class="na">retransformClasses</span><span class="o">(</span><span class="n">waitingReTransformClass</span><span class="o">);</span>
</code></pre></div></div><p>让他经过transformer重定义。</p><h2 id="被测类中插入的探针及方法">被测类中插入的探针及方法</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">XXX</span><span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">$jacocoData</span><span class="o">;</span> <span class="c1">// 缓存这个类的探针</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">$jacocoInit</span><span class="o">(){</span>
		<span class="c1">// 当$jacocoData为null时，</span>
		<span class="c1">// 向UnknownError.$jacocoAccess，即RuntimeData索要探针</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>那么，将这两个数据移到外部，为每个类XXX，构造一个类 XXX$GeneratedByJacoco 。</p><p>构造出来的类存放这两个数据或方法，用ASM构造出来，是一个byte[]，表示字节码。</p><p>那么要将其挂在一个加载器上。</p><h3 id="构造类挂在哪个加载器">构造类挂在哪个加载器？</h3><p>考虑把 XXX$GeneratedByJacoco 的字节码byte[] 挂在 XXX的加载器上（前提是XXX的加载器不是根加载器null).</p><p>理由，借 <a href="https://ykry35.github.io/blog.github.io/wiki/jvms8.pdf">Java SE8 虚拟机规范</a> 的一条说明：</p><p>5.3Creation and Loading</p><p>Creation of a class or interface C denoted by the name N consists of the construction in the method area of the Java Virtual Machine (§2.5.4) of an implementation-specific internal representation of C. Class or interface creation is triggered by another class or interface D, which references C through its run-time constant pool.</p><p>The Java Virtual Machine uses one of three procedures to create class or interfaceC denoted by N:</p><p>• If N denotes a nonarray class or an interface, one of the two following methods is used to load and thereby create C:</p><p>– If D was defined by the bootstrap class loader, then the bootstrap class loader initiates loading of C (§5.3.1).</p><p>– If D was defined by a user-defined class loader, then that same user-definedclass loader initiates loading of C (§5.3.2).</p><p>即，类 D 的加载器是 L ， D 的运行常量池中有符号引号 N，N 是 类 C 的名字。 如果 L != null （非bootstrap classloader)， 则当 N 在 类D 中被用到时， 会由 D 的加载器 L 去加载 C 。</p><p><strong>所以，XXX$GeneratedByJacoco 挂在 XXX 的加载器上，XXX用到它时，会用XXX的加载器去加载，如果已经加载过了，则不会再触发loadClass了。挂在这上面合理。</strong></p><h3 id="如何把byte字节码挂在加载器">如何把byte[]字节码挂在加载器？</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassLoader</span><span class="o">{</span>
	<span class="kd">protected</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">defineClass</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">ClassFormatError</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="nf">defineClass</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">len</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>反射调用这个方法，把字节码byte[]挂到这个ClassLoader上。</p><p>todo: 不确定会不会有什么隐患。 ProtectionDomain啊啥的还么去看。而且这个方法是@Deprecated .</p><h3 id="强行挂的类是否会被gc">强行挂的类是否会被gc?</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassLoader</span><span class="o">{</span>
	<span class="c1">// The classes loaded by this class loader. The only purpose of this table</span>
    <span class="c1">// is to keep the classes from being GC'ed until the loader is GC'ed.</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Vector</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vector</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>
</code></pre></div></div><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Class</span><span class="o">{</span>
    <span class="c1">// Initialized in JVM not by private constructor</span>
    <span class="c1">// This field is filtered from reflection access, i.e. getDeclaredField</span>
    <span class="c1">// will throw NoSuchFieldException</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>只要 类XXX 还在，那他的加载器就在，加载器在，那这个加载器加载过的所有Class都在。</p><p>XXX 和 XXX$GeneratedByJacoco 是共存的。</p><h1 id="对原进程的影响">对原进程的影响</h1><h2 id="内存影响">内存影响</h2><p>分成 元空间（方法区） 和 堆区讨论。</p><h3 id="元空间影响">元空间影响</h3><p>每个Java的类，在元空间是一个InstanceKlass实例。</p><p>InstanceKlass在这个类加载器的空间内（这块笔者还没理清）。</p><p>所以方法区会多很多InstanceKlass。定量评估受限于水平，后面会做定性的比较。</p><h3 id="堆区影响">堆区影响</h3><p>每个Java类的反射模型，比如 XXX.class 是 java/lang/Class类型，它是堆中的InstanceMirrorKlass。</p><p>Java类的静态变量也都在这个 InstanceMirrorKlass中。</p><p>所以堆中，会多很多InstanceMirrotKlass。</p><h3 id="比较">比较</h3><p>但由于元空间在整个内存中占比较小，所以对元空间影响相比堆区更大。</p><p>可以考虑适当增加一点初始元空间分配，减少Full GC。 -XX:MetaspaceSize= -XX:MaxMetaspaceSize=</p><h2 id="性能影响">性能影响</h2><p>我个人觉得，没啥影响。</p><p>开始 XXX 访问 XXX 的方法或变量，之后改成 XXX 访问 XXX$GeneratedByJacoco 的方法或变量。</p><p>第一次访问时，都经历常量池下标引用转内存地址引用 （Linking）； 后面再次访问，直接访问内存地址。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://ykry35.github.io/blog.github.io" target="_blank">Chaoxin Zhou</a></li><li>本文链接：<a href="https://ykry35.github.io/blog.github.io/hidden/jacoco_attach/" target="_blank">https://ykry35.github.io/blog.github.io/hidden/jacoco_attach/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://ykry35.github.io/blog.github.io/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/hidden/jacoco_attach/', clientID: 'a3a0fbaad3e91f2e2342', clientSecret: 'f82d523505992a3aab199b818ecff081b65f1a60', repo: 'blog.github.io', owner: 'ykry35', admin: ['ykry35'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://ykry35.github.io/blog.github.io/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://ykry35.github.io/blog.github.io/assets/search_data.json?v=1673325926', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://ykry35.github.io/blog.github.io/assets/js/jquery.toc.js"></script></div></div><script type="text/javascript"> $(document).ready(function(){ const jekyllConfigId = '#jekyllconfig'; const imageGroupClass = '.images_group'; $(jekyllConfigId).hide(); var configStr = $(jekyllConfigId).text().trim(); const jekyllConfig = JSON.parse(configStr); console.log("jekyllConfig", jekyllConfig); $(imageGroupClass + ' li').css('width', jekyllConfig['viewerjs']['img_width']); $(imageGroupClass).each(function(index, element) { new Viewer(element); }); }); </script></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Chaoxin Zhou">Chaoxin Zhou</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/YKRY35/" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://ykry35.github.io/blog.github.io/" title="首页" target="">首页</a></li><li> <a href="https://ykry35.github.io/blog.github.io/categories/" title="分类" target="">分类</a></li><li> <a href="https://ykry35.github.io/blog.github.io/wiki/" title="维基" target="">维基</a></li><li> <a href="https://ykry35.github.io/blog.github.io/links/" title="链接" target="">链接</a></li><li> <a href="https://ykry35.github.io/blog.github.io/about/" title="关于" target="">关于</a></li><li><a href="https://ykry35.github.io/blog.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://ykry35.github.io/blog.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
